{% extends "web/base.html" %}

{% block title %}Mis Reservas{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4"><i class="bi bi-calendar-check"></i> Mis Reservas</h2>
            
            <div id="loading" class="text-center my-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
            
            <div id="reservas-container" class="row" style="display: none;">
                <!-- Las reservas se cargarán aquí dinámicamente -->
            </div>
            
            <div id="sin-reservas" class="alert alert-info" style="display: none;">
                <i class="bi bi-info-circle"></i> No tienes reservas registradas aún.
                <a href="{{ url_for('web.paquetes') }}" class="alert-link">Explora nuestros paquetes</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    cargarReservas();
});

async function cargarReservas() {
    try {
        const response = await fetch('/api/reservas');
        const reservas = await response.json();
        
        // Filtrar solo las reservas del usuario actual
        const usuarioId = {{ session.get('usuario_id', 0) }};
        const misReservas = reservas.filter(r => r.usuario_id === usuarioId);
        
        document.getElementById('loading').style.display = 'none';
        
        if (misReservas.length === 0) {
            document.getElementById('sin-reservas').style.display = 'block';
            return;
        }
        
        document.getElementById('reservas-container').style.display = 'flex';
        const container = document.getElementById('reservas-container');
        container.innerHTML = '';
        
        misReservas.forEach(reserva => {
            const card = crearCardReserva(reserva);
            container.appendChild(card);
        });
    } catch (error) {
        console.error('Error al cargar reservas:', error);
        document.getElementById('loading').innerHTML = 
            '<div class="alert alert-danger">Error al cargar las reservas. Por favor, recarga la página.</div>';
    }
}

function crearCardReserva(reserva) {
    const col = document.createElement('div');
    col.className = 'col-md-6 col-lg-4 mb-4';
    
    const estadoClass = {
        'confirmada': 'success',
        'cancelada': 'danger',
        'completada': 'info'
    }[reserva.estado] || 'secondary';
    
    const fechaReserva = new Date(reserva.fecha_reserva).toLocaleDateString('es-CL');
    const fechaInicio = reserva.paquete?.fecha_inicio ? 
        new Date(reserva.paquete.fecha_inicio).toLocaleDateString('es-CL') : 'N/A';
    const fechaFin = reserva.paquete?.fecha_fin ? 
        new Date(reserva.paquete.fecha_fin).toLocaleDateString('es-CL') : 'N/A';
    
    col.innerHTML = `
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-${estadoClass} text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-light text-dark">Reserva #${reserva.id}</span>
                    <span class="badge bg-${estadoClass === 'success' ? 'light' : 'dark'} text-${estadoClass === 'success' ? 'dark' : 'white'}">
                        ${reserva.estado.charAt(0).toUpperCase() + reserva.estado.slice(1)}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title">${reserva.paquete?.nombre || 'Paquete no disponible'}</h5>
                <hr>
                <p class="mb-2"><strong><i class="bi bi-calendar"></i> Fecha de Reserva:</strong> ${fechaReserva}</p>
                <p class="mb-2"><strong><i class="bi bi-calendar-event"></i> Viaje:</strong> ${fechaInicio} - ${fechaFin}</p>
                <p class="mb-2"><strong><i class="bi bi-people"></i> Pasajeros:</strong> ${reserva.numero_pasajeros}</p>
                ${reserva.paquete?.precio_total ? 
                    `<p class="mb-2"><strong><i class="bi bi-currency-dollar"></i> Total:</strong> ${formatCLP(reserva.paquete.precio_total)}</p>` : ''}
                ${reserva.paquete?.destinos && reserva.paquete.destinos.length > 0 ? `
                    <hr>
                    <div class="mb-3">
                        <strong><i class="bi bi-geo-alt-fill text-danger"></i> Destinos incluidos:</strong>
                        ${reserva.paquete.destinos.map(destino => `
                            <div class="mt-2 p-2 rounded border-start border-primary border-3 bg-light">
                                <h6 class="text-dark fw-bold mb-1">
                                    <i class="bi bi-geo-alt-fill text-danger me-1"></i>${destino.nombre}
                                </h6>
                                ${destino.descripcion ? `
                                    <p class="small text-muted mb-2 text-center">${destino.descripcion}</p>
                                ` : ''}
                                ${destino.actividades && destino.actividades.length > 0 ? `
                                    <div class="d-flex flex-wrap gap-1 justify-content-center">
                                        ${destino.actividades.map(actividad => `
                                            <span class="badge bg-purple-pastel text-purple-dark fw-bold">${actividad.trim()}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                ${reserva.telefono_contacto ? 
                    `<p class="mb-2"><strong><i class="bi bi-telephone"></i> Contacto:</strong> ${reserva.telefono_contacto}</p>` : ''}
                ${reserva.comentarios ? 
                    `<p class="mb-2"><strong><i class="bi bi-chat-left-text"></i> Comentarios:</strong><br><small>${reserva.comentarios}</small></p>` : ''}
                ${reserva.viajeros && reserva.viajeros.length > 0 ? 
                    `<div class="mt-3"><strong><i class="bi bi-person-badge"></i> Viajeros:</strong><ul class="list-unstyled ms-3 mt-2">${reserva.viajeros.map(v => `<li>${v.nombre_completo} (${v.rut})</li>`).join('')}</ul></div>` : ''}
            </div>
            <div class="card-footer bg-transparent">
                ${reserva.estado === 'confirmada' ? 
                    `<button class="btn btn-sm btn-outline-danger w-100" onclick="cancelarReserva(${reserva.id})">
                        <i class="bi bi-x-circle"></i> Cancelar Reserva
                    </button>` : ''}
            </div>
        </div>
    `;
    
    return col;
}

async function cancelarReserva(reservaId) {
    if (!confirm('¿Estás seguro de que deseas cancelar esta reserva?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/reservas/${reservaId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ estado: 'cancelada' })
        });
        
        if (response.ok) {
            mostrarToast('Reserva cancelada exitosamente', 'success', 'Éxito');
            setTimeout(() => location.reload(), 1500);
        } else {
            const error = await response.json();
            mostrarToast(error.error || 'Error al cancelar la reserva', 'error', 'Error');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarToast('Error al cancelar la reserva', 'error', 'Error');
    }
}
</script>
{% endblock %}

