{% extends "web/base.html" %}

{% block title %}Inicio - Viajes Aventura{% endblock %}

{% block content %}
<div class="card mb-5" style="background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%); border: none;">
    <div class="card-body p-5 text-center text-white">
        <h1 class="display-4 fw-semibold mb-3" style="color: white;">
Viajes Aventura
        </h1>
        <p class="lead mb-0" style="color: rgba(255, 255, 255, 0.9); font-size: 1.1rem;">
            Descubre los mejores destinos y paquetes turísticos del mundo
        </p>
    </div>
</div>

<div class="card mb-3" style="border: 1px solid var(--border-gray); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">
    <div class="card-body p-4">
        <form id="form-buscar-inicio" class="row g-3 align-items-end">
            <div class="col-md-2">
                <label class="form-label fw-bold text-primary small"><i class="bi bi-geo-alt-fill text-dark me-1"></i> Origen</label>
                <input type="text" class="form-control" id="origen" placeholder="Ej: Santiago" value="Punta Arenas">
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold text-primary small"><i class="bi bi-geo-alt text-danger"></i> Destino</label>
                <input type="text" class="form-control" id="destino" placeholder="Ej: París">
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold text-primary small"><i class="bi bi-calendar3"></i> Fecha Inicio</label>
                <input type="date" class="form-control" id="fecha_inicio" placeholder="Seleccionar fecha">
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold text-primary small"><i class="bi bi-calendar-check"></i> Fecha Fin</label>
                <input type="date" class="form-control" id="fecha_fin" placeholder="Seleccionar fecha">
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold text-primary small"><i class="bi bi-currency-dollar"></i> Rango de Precio</label>
                <div class="price-range-container" id="price-range-inicio">
                    <div class="price-range-slider">
                        <div class="range-track"></div>
                        <input type="range" id="precio_min_slider" min="0" max="50000" step="1000" value="0">
                        <input type="range" id="precio_max_slider" min="0" max="50000" step="1000" value="50000">
                    </div>
                    <div class="price-range-values">
                        <div class="flex-fill">
                            <div class="price-value-label">Mínimo</div>
                            <div class="price-value" id="precio_min_display">$0</div>
                        </div>
                        <div class="flex-fill">
                            <div class="price-value-label">Máximo</div>
                            <div class="price-value" id="precio_max_display">$50.000</div>
                        </div>
                    </div>
                    <input type="hidden" id="precio_min" value="0">
                    <input type="hidden" id="precio_max" value="50000">
                </div>
            </div>
        </form>
    </div>
</div>

<div id="paquetes-destacados" class="mt-5">
    <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-2 text-muted small">Cargando paquetes destacados...</p>
    </div>
</div>

<script>
let todosPaquetes = [];
let paquetesDestacados = [];

async function cargarPaquetes(destacados = true) {
    try {
        // Cargar paquetes destacados o todos según el parámetro
        let url = destacados ? '/api/paquetes?destacados=true' : '/api/paquetes';
        let response = await fetch(url);
        if (!response.ok) throw new Error(`Error ${response.status}`);
        let paquetes = await response.json();
        if (paquetes.error) throw new Error(paquetes.error);
        
        // Si no hay destacados, cargar todos y tomar los primeros 4
        if (destacados && (!paquetes || paquetes.length === 0)) {
            response = await fetch('/api/paquetes');
            if (!response.ok) throw new Error(`Error ${response.status}`);
            paquetes = await response.json();
            if (paquetes.error) throw new Error(paquetes.error);
            // Tomar los primeros 4 paquetes disponibles
            paquetes = paquetes.filter(p => p.disponibles > 0).slice(0, 4);
        } else if (destacados && paquetes.length < 4) {
            // Si hay menos de 4 destacados, completar con todos los paquetes hasta 4
            response = await fetch('/api/paquetes');
            if (response.ok) {
                const todosPaquetes = await response.json();
                if (!todosPaquetes.error) {
                    const idsDestacados = new Set(paquetes.map(p => p.id));
                    const adicionales = todosPaquetes
                        .filter(p => !idsDestacados.has(p.id) && p.disponibles > 0)
                        .slice(0, 4 - paquetes.length);
                    paquetes = [...paquetes, ...adicionales];
                }
            }
        } else if (destacados) {
            // Limitar a 4 paquetes máximo
            paquetes = paquetes.slice(0, 4);
        }
        
        if (destacados) {
            paquetesDestacados = paquetes;
            todosPaquetes = paquetes; // Inicialmente mostrar solo destacados
        } else {
            todosPaquetes = paquetes; // Cargar todos para filtros
        }
        
        filtrarPaquetes();
    } catch (error) {
        // Si falla, intentar cargar todos los paquetes como último recurso
        try {
            const response = await fetch('/api/paquetes');
            if (response.ok) {
                const paquetes = await response.json();
                if (!paquetes.error && paquetes.length > 0) {
                    const paquetesDisponibles = paquetes.filter(p => p.disponibles > 0).slice(0, 4);
                    if (paquetesDisponibles.length > 0) {
                        paquetesDestacados = paquetesDisponibles;
                        todosPaquetes = paquetesDisponibles;
                        filtrarPaquetes();
                        return;
                    }
                }
            }
        } catch (e) {
            // Si todo falla, mostrar mensaje de error
        }
        document.getElementById('paquetes-destacados').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> No se pudieron cargar los paquetes. Por favor, intenta más tarde.
            </div>
        `;
    }
}

function mostrarPaquetes(paquetes, titulo = 'Paquetes Destacados') {
    const container = document.getElementById('paquetes-destacados');
    
    if (!paquetes || paquetes.length === 0) {
        container.innerHTML = `
            <h2 class="mb-4 fw-semibold">${titulo}</h2>
            <div class="card">
                <div class="card-body p-5">
                    <p class="text-muted mb-0">No se encontraron resultados para los filtros aplicados</p>
                </div>
            </div>
        `;
        return;
    }
    
    let subtitulo = '';
    if (titulo === 'Paquetes Destacados') {
        subtitulo = '<p class="text-muted mb-4">Los paquetes mas populares y visitados</p>';
    }
    
    let cardsHTML = `
        <h2 class="mb-2 fw-semibold">${titulo}</h2>
        ${subtitulo}
        <div class="row g-4">
    `;
    
    paquetes.forEach(paquete => {
        const fechaInicio = new Date(paquete.fecha_inicio).toLocaleDateString('es-ES');
        const fechaFin = new Date(paquete.fecha_fin).toLocaleDateString('es-ES');
        const dias = Math.ceil((new Date(paquete.fecha_fin) - new Date(paquete.fecha_inicio)) / (1000 * 60 * 60 * 24));
        const destinos = paquete.destinos.map(d => d.nombre).join(', ') || 'Sin destinos';
        
        cardsHTML += `
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="card shadow-sm h-100 border-0 rounded-3">
                    <div class="card-body p-4 d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title text-dark fw-bold mb-0">${paquete.nombre}</h5>
                            <span class="badge ${paquete.disponibles > 0 ? 'badge-cupos' : 'bg-danger'} ms-2">
                                ${paquete.disponibles > 0 ? `${paquete.disponibles} cupos` : 'Agotado'}
                            </span>
                        </div>
                        
                        <div class="mb-3 flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between mb-3 p-3 rounded bg-light border">
                                <div class="d-flex align-items-center flex-fill">
                                    <div>
                                        <small class="text-muted d-block">Origen</small>
                                        <strong>${paquete.origen || 'N/A'}</strong>
                                    </div>
                                </div>
                                <i class="bi bi-arrow-right text-primary mx-3"></i>
                                <div class="d-flex align-items-center flex-fill">
                                    <i class="bi bi-geo-alt-fill text-danger me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Destinos</small>
                                        <strong>${destinos}</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center justify-content-between p-2 rounded bg-light mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-clock text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Duración</small>
                                        <strong class="small">${dias} días</strong>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar3 text-primary me-2"></i>
                                    <div>
                                        <small class="text-muted d-block">Fechas</small>
                                        <strong class="small">${fechaInicio} - ${fechaFin}</strong>
                                    </div>
                                </div>
                            </div>
                            
                            ${paquete.destinos && paquete.destinos.length > 0 ? `
                                <div class="mb-3">
                                    ${paquete.destinos.map(destino => {
                                        const actividadesArray = Array.isArray(destino.actividades) ? destino.actividades : (destino.actividades ? destino.actividades.split(',').map(a => a.trim()) : []);
                                        const descripcion = destino.descripcion || '';
                                        return `
                                            <div class="mb-3">
                                                ${actividadesArray.length > 0 ? `
                                                    <div class="mb-2">
                                                        <small class="text-muted d-block mb-2 text-center">
                                                            <i class="bi bi-list-check text-warning me-1"></i> Actividades
                                                        </small>
                                                        <div class="d-flex flex-wrap gap-1 justify-content-center">
                                                            ${actividadesArray.slice(0, 3).map(act => `<span class="badge bg-purple-pastel text-purple-dark small">${act}</span>`).join('')}
                                                            ${actividadesArray.length > 3 ? `<span class="badge bg-secondary-subtle text-secondary small">+${actividadesArray.length - 3}</span>` : ''}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                
                                                ${descripcion ? `
                                                    <div class="mb-0 text-center">
                                                        <p class="text-muted small mb-0 lh-sm">${descripcion}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="mt-auto border-top pt-3">
                            <div class="text-center mb-3">
                                <small class="text-muted d-block mb-1">Precio Total</small>
                                <h3 class="text-primary fw-bold mb-0">${formatCLP(paquete.precio_total)}</h3>
                            </div>
                            ${paquete.disponibles > 0 ? 
                                `<div class="mb-3">
                                    <label class="form-label small fw-bold text-muted mb-2">Cantidad</label>
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm cantidad-btn" 
                                                onclick="cambiarCantidad('paquete-${paquete.id}', -1, ${paquete.disponibles})" 
                                                id="btn-restar-${paquete.id}"
                                                disabled>
                                            <i class="bi bi-dash-lg"></i>
                                        </button>
                                        <input type="number" 
                                               class="form-control text-center cantidad-input" 
                                               id="cantidad-paquete-${paquete.id}" 
                                               value="1" 
                                               min="1" 
                                               max="${paquete.disponibles}" 
                                               readonly
                                               style="max-width: 80px; -webkit-appearance: none !important; -moz-appearance: textfield !important; appearance: none !important;">
                                        <button type="button" class="btn btn-outline-primary btn-sm cantidad-btn" 
                                                onclick="cambiarCantidad('paquete-${paquete.id}', 1, ${paquete.disponibles})" 
                                                id="btn-sumar-${paquete.id}"
                                                ${paquete.disponibles <= 1 ? 'disabled' : ''}>
                                            <i class="bi bi-plus-lg"></i>
                                        </button>
                                    </div>
                                </div>
                                <button class="btn btn-success w-100" onclick="agregarAlCarritoConCantidad('paquete', ${paquete.id})">
                                    <i class="bi bi-cart-plus-fill me-2"></i> Agregar al Carrito
                                </button>` : 
                                '<button class="btn btn-secondary w-100" disabled>Agotado</button>'
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    cardsHTML += '</div>';
    container.innerHTML = cardsHTML;
}

function obtenerValoresFiltros() {
    const origenEl = document.getElementById('origen');
    const destinoEl = document.getElementById('destino');
    const fechaInicioEl = document.getElementById('fecha_inicio');
    const fechaFinEl = document.getElementById('fecha_fin');
    const precioMinSlider = document.getElementById('precio_min_slider');
    const precioMaxSlider = document.getElementById('precio_max_slider');
    
    return {
        origen: origenEl ? origenEl.value.toLowerCase() : '',
        destino: destinoEl ? destinoEl.value.toLowerCase() : '',
        fechaInicio: fechaInicioEl ? fechaInicioEl.value : '',
        fechaFin: fechaFinEl ? fechaFinEl.value : '',
        precioMin: precioMinSlider ? parseFloat(precioMinSlider.value) : 0,
        precioMax: precioMaxSlider ? parseFloat(precioMaxSlider.value) : 50000
    };
}

async function filtrarPaquetes() {
    const filtros = obtenerValoresFiltros();
    const tieneFiltros = filtros.origen || filtros.destino || filtros.fechaInicio || filtros.fechaFin || filtros.precioMin > 0 || filtros.precioMax < 50000;
    
    // Si hay filtros activos, cargar todos los paquetes para buscar
    if (tieneFiltros && todosPaquetes.length === paquetesDestacados.length) {
        await cargarPaquetes(false); // Cargar todos los paquetes
    }
    
    if (!todosPaquetes || todosPaquetes.length === 0) {
        mostrarPaquetes([], 'Paquetes Destacados');
        return;
    }
    
    const paquetesFiltrados = todosPaquetes.filter(p => {
        if (filtros.origen && (!p.origen || !p.origen.toLowerCase().includes(filtros.origen))) return false;
        if (filtros.destino) {
            const destinosStr = p.destinos.map(d => d.nombre).join(' ').toLowerCase();
            if (!destinosStr.includes(filtros.destino)) return false;
        }
        if (filtros.fechaInicio) {
            const fechaInicioPaquete = new Date(p.fecha_inicio);
            const fechaInicioFiltro = new Date(filtros.fechaInicio);
            if (fechaInicioPaquete < fechaInicioFiltro) return false;
        }
        if (filtros.fechaFin) {
            const fechaFinPaquete = new Date(p.fecha_fin);
            const fechaFinFiltro = new Date(filtros.fechaFin);
            if (fechaFinPaquete > fechaFinFiltro) return false;
        }
        if (p.precio_total < filtros.precioMin || p.precio_total > filtros.precioMax) return false;
        return true;
    });
    
    mostrarPaquetes(paquetesFiltrados, 'Paquetes Destacados');
}

function init() {
    initPriceSlider('price-range-inicio', () => {
        filtrarPaquetes();
    });
    setupBusquedaTiempoReal(() => {
        filtrarPaquetes();
    });
    cargarPaquetes(true); // Cargar paquetes destacados inicialmente
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// Funciones para manejar cantidad de paquetes
function cambiarCantidad(prefijo, cambio, maxDisponibles) {
    const inputId = `cantidad-${prefijo}`;
    const input = document.getElementById(inputId);
    if (!input) {
        console.error('No se encontró el input:', inputId);
        return;
    }
    
    let cantidadActual = parseInt(input.value) || 1;
    let nuevaCantidad = cantidadActual + cambio;
    
    // Validar límites
    if (nuevaCantidad < 1) nuevaCantidad = 1;
    if (nuevaCantidad > maxDisponibles) nuevaCantidad = maxDisponibles;
    
    input.value = nuevaCantidad;
    
    // Actualizar estado de botones
    const paqueteId = prefijo.replace('paquete-', '');
    const btnRestar = document.getElementById(`btn-restar-${paqueteId}`);
    const btnSumar = document.getElementById(`btn-sumar-${paqueteId}`);
    
    if (btnRestar) {
        btnRestar.disabled = nuevaCantidad <= 1;
    }
    if (btnSumar) {
        btnSumar.disabled = nuevaCantidad >= maxDisponibles;
    }
}

async function agregarAlCarritoConCantidad(tipo, id) {
    const input = document.getElementById(`cantidad-${tipo}-${id}`);
    const cantidad = input ? parseInt(input.value) || 1 : 1;
    
    if (cantidad < 1) {
        alert('La cantidad debe ser al menos 1');
        return;
    }
    
    try {
        const response = await fetch('/api/carrito/agregar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                tipo: tipo,
                id: id,
                cantidad: cantidad
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Usar mostrarToast si está disponible
            if (typeof mostrarToast === 'function') {
                mostrarToast(data.message || `${cantidad} paquete(s) agregado(s) al carrito`, 'success', '¡Agregado!');
            } else if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: '¡Agregado!',
                    text: `${cantidad} paquete(s) agregado(s) al carrito`,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000
                });
            } else {
                alert(`Agregado al carrito: ${cantidad} paquete(s)`);
            }
            
            // Actualizar contador del carrito si existe
            if (typeof actualizarContadorCarrito === 'function') {
                actualizarContadorCarrito();
            } else if (data.cantidad !== undefined) {
                const contador = document.getElementById('carrito-contador');
                if (contador) {
                    if (data.cantidad > 0) {
                        contador.textContent = data.cantidad;
                        contador.style.display = 'inline-block';
                    } else {
                        contador.style.display = 'none';
                    }
                }
            }
        } else {
            throw new Error(data.error || 'Error al agregar al carrito');
        }
    } catch (error) {
        if (typeof mostrarToast === 'function') {
            mostrarToast(error.message || 'Error al agregar al carrito', 'error', 'Error');
        } else if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message
            });
        } else {
            alert('Error: ' + error.message);
        }
    }
}

// La función agregarAlCarrito está disponible globalmente desde base.html
</script>
{% endblock %}
