{% extends "web/base.html" %}

{% block title %}Carrito de Compras - Viajes Aventura{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4 fw-bold">
                <i class="bi bi-cart-fill text-primary me-2"></i>Carrito de Compras
            </h1>
        </div>
    </div>
    
    <div id="carrito-container" class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-5 text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3 text-muted">Cargando carrito...</p>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
let carritoItems = [];

let carritoTotal = 0;

async function cargarCarrito() {
    try {
        const response = await fetch('/api/carrito');
        if (!response.ok) throw new Error('Error al cargar el carrito');
        const data = await response.json();
        carritoItems = data.items || [];
        carritoTotal = data.total || 0; // Usar el total del backend
        mostrarCarrito();
        actualizarContadorCarrito();
    } catch (error) {
        document.getElementById('carrito-container').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill"></i> Error al cargar el carrito
                </div>
            </div>
        `;
    }
}

function mostrarCarrito() {
    const container = document.getElementById('carrito-container');
    
    if (!carritoItems || carritoItems.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-5 text-center">
                        <i class="bi bi-cart-x text-muted" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-muted">Tu carrito está vacío</h3>
                        <p class="text-muted">Agrega paquetes para comenzar</p>
                        <a href="/paquetes" class="btn btn-primary">
                            <i class="bi bi-box-seam me-2"></i>Ver Paquetes
                        </a>
                    </div>
                </div>
            </div>
        `;
        return;
    }
    
    // Usar el total del backend o calcularlo si no está disponible
    const total = carritoTotal || carritoItems.reduce((sum, item) => sum + (item.subtotal || (item.precio || 0) * (item.cantidad || 1)), 0);
    
    let html = '<div class="col-lg-8 mb-4">';
    
    carritoItems.forEach(item => {
        const cantidad = item.cantidad || 1;
        const precioUnitario = item.precio || 0;
        const subtotal = item.subtotal || (precioUnitario * cantidad);
        
        if (item.tipo === 'paquete') {
            const fechaInicio = item.fecha_inicio ? new Date(item.fecha_inicio).toLocaleDateString('es-ES') : 'N/A';
            const fechaFin = item.fecha_fin ? new Date(item.fecha_fin).toLocaleDateString('es-ES') : 'N/A';
            const paqueteId = item.id;
            const maxCupos = item.disponibles || 1;
            html += `
                <div class="card mb-3 border-primary" data-paquete-id="${paqueteId}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5 class="card-title text-dark fw-bold mb-2">
                                    <i class="bi bi-box-seam me-2"></i>${item.nombre}
                                </h5>
                                <p class="text-muted small mb-1">
                                    <i class="bi bi-calendar3 me-1"></i>${fechaInicio} - ${fechaFin}
                                </p>
                                ${item.disponibles !== undefined ? `
                                    <div class="mb-2">
                                        <span class="badge ${item.disponibles > 0 ? 'badge-cupos' : 'bg-danger'}">
                                            ${item.disponibles > 0 ? `${item.disponibles} cupos disponibles` : 'Agotado'}
                                        </span>
                                    </div>
                                ` : ''}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        Precio unitario: <strong>${formatCLP(precioUnitario)}</strong>
                                    </small>
                                </div>
                            </div>
                            <div class="text-end ms-3">
                                <div class="mb-2">
                                    <small class="text-muted d-block">Subtotal</small>
                                    <h4 class="text-primary mb-0">${formatCLP(subtotal)}</h4>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="eliminarDelCarrito('${item.tipo}', ${item.id}, ${item.timestamp || item.carrito_index || 'null'}, ${item.carrito_index || 'null'})">
                                    <i class="bi bi-trash me-1"></i>Eliminar
                                </button>
                            </div>
                        </div>
                        
                        ${item.destinos && item.destinos.length > 0 ? `
                            <div class="mb-3">
                                ${item.destinos.map(destino => `
                                    <div class="mb-2 p-2 rounded border-start border-primary border-3 bg-light">
                                        <h6 class="text-dark fw-bold mb-1">
                                            <i class="bi bi-geo-alt-fill text-danger me-1"></i>${destino.nombre}
                                        </h6>
                                        ${destino.descripcion ? `
                                            <p class="small text-muted mb-2">${destino.descripcion}</p>
                                        ` : ''}
                                        ${destino.actividades && destino.actividades.length > 0 ? `
                                            <div class="d-flex flex-wrap gap-1">
                                                ${destino.actividades.map(actividad => `
                                                    <span class="badge bg-purple-pastel text-purple-dark fw-bold">${actividad.trim()}</span>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <hr class="my-3">
                        
                        <div class="datos-viajero-paquete" data-paquete-id="${paqueteId}">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Número de Pasajeros <span class="text-danger">*</span></label>
                                <input type="number" class="form-control numero-pasajeros-paquete" 
                                       data-paquete-id="${paqueteId}" 
                                       data-precio="${precioUnitario}"
                                       min="1" 
                                       max="${maxCupos}" 
                                       value="1" 
                                       required>
                                <small class="text-muted">Máximo ${maxCupos} pasajero(s)</small>
                                <div class="error-cupos-paquete text-danger small mt-1" data-paquete-id="${paqueteId}" style="display: none;"></div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <span class="fw-bold">Total del Paquete:</span>
                                    <span class="h5 mb-0 text-primary total-paquete" data-paquete-id="${paqueteId}">${formatCLP(precioUnitario)}</span>
                                </div>
                                <small class="text-muted">Precio unitario: ${formatCLP(precioUnitario)} × <span class="cantidad-pasajeros-display" data-paquete-id="${paqueteId}">1</span> pasajero(s)</small>
                            </div>
                            <div class="viajeros-container-paquete" data-paquete-id="${paqueteId}">
                                <!-- Se llenará dinámicamente con formularios para cada viajero -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    html += '</div>';
    
    // Función para calcular el total del carrito considerando número de pasajeros por paquete
    function calcularTotalCarrito() {
        let total = 0;
        carritoItems.forEach(item => {
            if (item.tipo === 'paquete') {
                // Para paquetes, obtener el número de pasajeros del input
                const numeroPasajerosInput = document.querySelector(`.numero-pasajeros-paquete[data-paquete-id="${item.id}"]`);
                const numPasajeros = numeroPasajerosInput ? parseInt(numeroPasajerosInput.value) || 1 : 1;
                total += (item.precio || 0) * numPasajeros;
            }
        });
        return total;
    }
    
    // Calcular cantidad total de items (sumando cantidades)
    const cantidadTotalItems = carritoItems.reduce((sum, item) => sum + (item.cantidad || 1), 0);
    
    // Calcular subtotal inicial
    let subtotalCalculado = calcularTotalCarrito();
    
    html += `
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h5 class="card-title mb-4">Resumen de Compra</h5>
                    
                    ${carritoItems.map(item => {
                        const cantidad = item.cantidad || 1;
                        const precioUnitario = item.precio || 0;
                        let subtotal = item.subtotal || (precioUnitario * cantidad);
                        let descripcion = `${cantidad} × ${formatCLP(precioUnitario)}`;
                        
                        // Para paquetes, mostrar según número de pasajeros
                        if (item.tipo === 'paquete') {
                            descripcion = `1 paquete × ${formatCLP(precioUnitario)}`;
                            subtotal = precioUnitario; // Inicialmente 1 pasajero
                        }
                        
                        return `
                            <div class="mb-3 pb-3 border-bottom resumen-item" data-item-id="${item.id}" data-item-tipo="${item.tipo}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <span class="small text-muted">${item.nombre}</span>
                                </div>
                                <div class="d-flex justify-content-between small mb-1">
                                    <span class="text-muted resumen-descripcion" data-item-id="${item.id}">${descripcion}</span>
                                    <strong class="resumen-subtotal" data-item-id="${item.id}">${formatCLP(subtotal)}</strong>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-2 small text-muted">
                        <span>${carritoItems.length} ${carritoItems.length === 1 ? 'producto' : 'productos'} (${cantidadTotalItems} ${cantidadTotalItems === 1 ? 'unidad' : 'unidades'})</span>
                    </div>
                    <div class="d-flex justify-content-between mb-4 p-3 bg-light rounded">
                        <h5 class="mb-0 fw-bold">Total:</h5>
                        <h4 class="text-primary mb-0 fw-bold" id="carrito-total-final">${formatCLP(subtotalCalculado)}</h4>
                    </div>
                    <button class="btn btn-primary w-100 mb-2" onclick="procederReserva()">
                        <i class="bi bi-check-circle-fill me-2"></i>Proceder a Reservar
                    </button>
                    <button class="btn btn-outline-secondary w-100" onclick="limpiarCarrito()">
                        <i class="bi bi-trash me-2"></i>Limpiar Carrito
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Agregar listeners a los inputs de número de pasajeros para paquetes
    document.querySelectorAll('.numero-pasajeros-paquete').forEach(input => {
        input.addEventListener('input', function() {
            const paqueteId = this.getAttribute('data-paquete-id');
            const numPasajeros = parseInt(this.value) || 0;
            const maxCupos = parseInt(this.getAttribute('max')) || 1;
            const precioUnitario = parseFloat(this.getAttribute('data-precio')) || 0;
            const errorDiv = document.querySelector(`.error-cupos-paquete[data-paquete-id="${paqueteId}"]`);
            const viajerosContainer = document.querySelector(`.viajeros-container-paquete[data-paquete-id="${paqueteId}"]`);
            const totalDiv = document.querySelector(`.total-paquete[data-paquete-id="${paqueteId}"]`);
            const cantidadDisplay = document.querySelector(`.cantidad-pasajeros-display[data-paquete-id="${paqueteId}"]`);
            
            if (numPasajeros > maxCupos) {
                errorDiv.textContent = `Máximo ${maxCupos} pasajero(s) disponible(s)`;
                errorDiv.style.display = 'block';
                this.setCustomValidity(`Máximo ${maxCupos} pasajero(s)`);
                viajerosContainer.innerHTML = '';
            } else {
                errorDiv.style.display = 'none';
                this.setCustomValidity('');
                generarFormulariosViajerosPaquete(paqueteId, numPasajeros, viajerosContainer);
                
                // Actualizar total del paquete
                const total = precioUnitario * numPasajeros;
                if (totalDiv) {
                    totalDiv.textContent = formatCLP(total);
                }
                if (cantidadDisplay) {
                    cantidadDisplay.textContent = numPasajeros;
                }
                
                // Actualizar total del resumen de compra
                actualizarResumenCompra();
            }
        });
        
        // Generar formularios iniciales
        const paqueteId = input.getAttribute('data-paquete-id');
        const numPasajeros = parseInt(input.value) || 1;
        const viajerosContainer = document.querySelector(`.viajeros-container-paquete[data-paquete-id="${paqueteId}"]`);
        generarFormulariosViajerosPaquete(paqueteId, numPasajeros, viajerosContainer);
    });
}

// Función para actualizar el resumen de compra
function actualizarResumenCompra() {
    let total = 0;
    
    carritoItems.forEach(item => {
        if (item.tipo === 'paquete') {
            // Para paquetes, obtener el número de pasajeros del input
            const numeroPasajerosInput = document.querySelector(`.numero-pasajeros-paquete[data-paquete-id="${item.id}"]`);
            const numPasajeros = numeroPasajerosInput ? parseInt(numeroPasajerosInput.value) || 1 : 1;
            const precioUnitario = item.precio || 0;
            const subtotalPaquete = precioUnitario * numPasajeros;
            total += subtotalPaquete;
            
            // Actualizar el subtotal en el resumen
            const subtotalDiv = document.querySelector(`.resumen-subtotal[data-item-id="${item.id}"]`);
            const descripcionDiv = document.querySelector(`.resumen-descripcion[data-item-id="${item.id}"]`);
            if (subtotalDiv) {
                subtotalDiv.textContent = formatCLP(subtotalPaquete);
            }
            if (descripcionDiv) {
                descripcionDiv.textContent = `${numPasajeros} pasajero(s) × ${formatCLP(precioUnitario)}`;
            }
        } else {
            // Para destinos, usar el subtotal normal
            const subtotal = item.subtotal || (item.precio || 0) * (item.cantidad || 1);
            total += subtotal;
        }
    });
    
    // Actualizar el total final
    const totalFinalDiv = document.getElementById('carrito-total-final');
    if (totalFinalDiv) {
        totalFinalDiv.textContent = formatCLP(total);
    }
}

// Datos del usuario logueado (disponibles desde el template)
{% if usuario_data %}
const usuarioData = {
    nombre_completo: {{ usuario_data.nombre_completo|tojson }},
    rut: {{ usuario_data.rut|tojson }},
    email: {{ usuario_data.email|tojson }}
};
{% else %}
const usuarioData = null;
{% endif %}

// Función para generar formularios de viajeros para un paquete específico
function generarFormulariosViajerosPaquete(paqueteId, numViajeros, container) {
    container.innerHTML = '';
    
    container.innerHTML = '<h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-people-fill me-2"></i>Datos del Viajero</h6>';
    
    for (let i = 1; i <= numViajeros; i++) {
        const tieneUsuario = usuarioData !== null;
        container.innerHTML += `
            <div class="card mb-3 border-secondary">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <strong>Viajero ${i} ${i === 1 ? '(Titular)' : ''}</strong>
                    ${tieneUsuario && i === 1 ? `
                        <button type="button" class="btn btn-sm btn-light" onclick="usarDatosUsuario(${paqueteId}, ${i})">
                            <i class="bi bi-person-check me-1"></i>Usar mis datos
                        </button>
                    ` : ''}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Nombre Completo <span class="text-danger">*</span></label>
                            <input type="text" class="form-control viajero-nombre" data-paquete-id="${paqueteId}" data-viajero="${i}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">RUT <span class="text-danger">*</span></label>
                            <input type="text" class="form-control viajero-rut" data-paquete-id="${paqueteId}" data-viajero="${i}" placeholder="12.345.678-9" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Fecha de Nacimiento</label>
                            <input type="text" class="form-control viajero-fecha" data-paquete-id="${paqueteId}" data-viajero="${i}" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Teléfono</label>
                            <input type="tel" class="form-control viajero-telefono" data-paquete-id="${paqueteId}" data-viajero="${i}" placeholder="+56 9 1234 5678">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control viajero-email" data-paquete-id="${paqueteId}" data-viajero="${i}" placeholder="email@ejemplo.com">
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Inicializar Flatpickr para los campos de fecha de nacimiento de viajeros
    if (typeof flatpickr !== 'undefined') {
        const fechaInputs = container.querySelectorAll('.viajero-fecha');
        fechaInputs.forEach(input => {
            flatpickr(input, {
                locale: 'es',
                dateFormat: 'd/m/Y',
                maxDate: 'today',
                allowInput: true,
                clickOpens: true,
                theme: 'default',
                appendTo: document.body,
                monthSelectorType: 'static',
                animate: true,
                altInput: false,
                disableMobile: false,
                parseDate: function(datestr, format) {
                    // Permitir entrada manual en formato dd/mm/yyyy
                    if (datestr && datestr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                        const parts = datestr.split('/');
                        return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                    }
                    return null;
                }
            });
        });
    }
}

// Función para usar los datos del usuario logueado
function usarDatosUsuario(paqueteId, viajeroNum) {
    if (!usuarioData) {
        mostrarToast('No hay datos de usuario disponibles', 'error', 'Error');
        return;
    }
    
    const nombreInput = document.querySelector(`.viajero-nombre[data-paquete-id="${paqueteId}"][data-viajero="${viajeroNum}"]`);
    const rutInput = document.querySelector(`.viajero-rut[data-paquete-id="${paqueteId}"][data-viajero="${viajeroNum}"]`);
    const emailInput = document.querySelector(`.viajero-email[data-paquete-id="${paqueteId}"][data-viajero="${viajeroNum}"]`);
    
    if (nombreInput) nombreInput.value = usuarioData.nombre_completo || '';
    if (rutInput) rutInput.value = usuarioData.rut || '';
    if (emailInput) emailInput.value = usuarioData.email || '';
    
    mostrarToast('Datos del usuario cargados', 'success', '¡Listo!');
}

async function actualizarCantidadCarrito(tipo, id, nuevaCantidad) {
    if (nuevaCantidad < 1) {
        mostrarToast('La cantidad debe ser al menos 1', 'error', 'Error');
        return;
    }
    
    try {
        const response = await fetch('/api/carrito/actualizar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipo, id, cantidad: nuevaCantidad })
        });
        const data = await response.json();
        
        if (response.ok) {
            cargarCarrito(); // Recargar el carrito para mostrar los cambios
            actualizarContadorCarrito();
        } else {
            mostrarToast(data.error || 'Error al actualizar cantidad', 'error', 'Error');
        }
    } catch (error) {
        mostrarToast('Error de conexión', 'error', 'Error');
    }
}

async function eliminarDelCarrito(tipo, id, timestamp, carrito_index) {
    const result = await Swal.fire({
        title: '¿Eliminar del carrito?',
        text: '¿Estás seguro de que deseas eliminar este item?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const body = { tipo, id };
            if (timestamp !== null && timestamp !== undefined) {
                body.timestamp = timestamp;
            }
            if (carrito_index !== null && carrito_index !== undefined) {
                body.carrito_index = carrito_index;
            }
            const response = await fetch('/api/carrito/eliminar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await response.json();
            
            if (response.ok) {
                Swal.fire('Eliminado', data.message, 'success');
                cargarCarrito();
            } else {
                Swal.fire('Error', data.error || 'Error al eliminar', 'error');
            }
        } catch (error) {
            Swal.fire('Error', 'Error de conexión', 'error');
        }
    }
}

async function limpiarCarrito() {
    const result = await Swal.fire({
        title: '¿Limpiar carrito?',
        text: '¿Estás seguro de que deseas eliminar todos los items?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, limpiar',
        cancelButtonText: 'Cancelar'
    });
    
    if (result.isConfirmed) {
        try {
            const response = await fetch('/api/carrito/limpiar', {
                method: 'POST'
            });
            const data = await response.json();
            
            if (response.ok) {
                Swal.fire('Carrito limpiado', data.message, 'success');
                cargarCarrito();
            } else {
                Swal.fire('Error', data.error || 'Error al limpiar', 'error');
            }
        } catch (error) {
            Swal.fire('Error', 'Error de conexión', 'error');
        }
    }
}

function procederReserva() {
    // Verificar si el usuario está logueado
    const tieneUsuario = {{ 'true' if session.usuario_id else 'false' }};
    
    if (!tieneUsuario) {
        Swal.fire({
            title: 'Iniciar Sesión Requerido',
            text: 'Debes iniciar sesión para realizar reservas',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Iniciar Sesión',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/auth/login';
            }
        });
        return;
    }
    
    // Verificar que hay paquetes en el carrito
    const paquetesEnCarrito = carritoItems.filter(item => item.tipo === 'paquete');
    
    if (paquetesEnCarrito.length === 0) {
        mostrarToast('No hay paquetes en el carrito para reservar', 'error', 'Info');
        return;
    }
    
    // Validar y recopilar datos de viajeros por paquete directamente desde las cards
    const datosPorPaquete = [];
    let hayErrores = false;
    
    for (const paquete of paquetesEnCarrito) {
        const paqueteId = paquete.id;
        
        // Obtener número de pasajeros para este paquete
        const numeroPasajerosInput = document.querySelector(`.numero-pasajeros-paquete[data-paquete-id="${paqueteId}"]`);
        if (!numeroPasajerosInput) {
            mostrarToast(`Error: No se encontró el campo de número de pasajeros para ${paquete.nombre}`, 'error', 'Error');
            hayErrores = true;
            continue;
        }
        
        const numeroPasajeros = parseInt(numeroPasajerosInput.value) || 1;
        
        // Validar cupos
        if (paquete.disponibles < numeroPasajeros) {
            mostrarToast(`No hay suficientes cupos en ${paquete.nombre}. Disponibles: ${paquete.disponibles}, Solicitados: ${numeroPasajeros}`, 'error', 'Error');
            hayErrores = true;
            continue;
        }
        
        // Recopilar datos de viajeros para este paquete (siempre, incluso si es 1)
        const viajeros = [];
        for (let i = 1; i <= numeroPasajeros; i++) {
            const nombre = document.querySelector(`.viajero-nombre[data-paquete-id="${paqueteId}"][data-viajero="${i}"]`)?.value;
            const rut = document.querySelector(`.viajero-rut[data-paquete-id="${paqueteId}"][data-viajero="${i}"]`)?.value;
            const fechaInput = document.querySelector(`.viajero-fecha[data-paquete-id="${paqueteId}"][data-viajero="${i}"]`);
            let fecha = fechaInput?.value || null;
            
            // Convertir fecha de formato dd/mm/yyyy a yyyy-mm-dd si es necesario
            if (fecha && fecha.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                const parts = fecha.split('/');
                fecha = `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
            
            const telefono = document.querySelector(`.viajero-telefono[data-paquete-id="${paqueteId}"][data-viajero="${i}"]`)?.value;
            const email = document.querySelector(`.viajero-email[data-paquete-id="${paqueteId}"][data-viajero="${i}"]`)?.value;
            
            if (nombre && rut) {
                viajeros.push({
                    nombre_completo: nombre,
                    rut: rut,
                    fecha_nacimiento: fecha || null,
                    telefono: telefono || null,
                    email: email || null
                });
            }
        }
        
        // Validar que se hayan ingresado todos los viajeros requeridos para este paquete
        if (viajeros.length < numeroPasajeros) {
            mostrarToast(`Debes completar los datos de los ${numeroPasajeros} viajero${numeroPasajeros > 1 ? 's' : ''} para ${paquete.nombre}`, 'error', 'Error');
            hayErrores = true;
            continue;
        }
        
        datosPorPaquete.push({
            paquete_id: paqueteId,
            paquete_nombre: paquete.nombre,
            numero_pasajeros: numeroPasajeros,
            viajeros: viajeros
        });
    }
    
    if (hayErrores) {
        return;
    }
    
    // Solicitar teléfono de contacto y comentarios
    Swal.fire({
        title: 'Datos de Contacto',
        html: `
            <div class="text-start">
                <div class="mb-3">
                    <label class="form-label fw-bold">Teléfono de Contacto <span class="text-danger">*</span></label>
                    <input type="tel" id="telefono_contacto" class="form-control" placeholder="+56 9 1234 5678" required>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Comentarios o Notas Especiales</label>
                    <textarea id="comentarios" class="form-control" rows="3" placeholder="Ej: Requisitos especiales, preferencias de habitación, etc."></textarea>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Confirmar Reservas',
        cancelButtonText: 'Cancelar',
        preConfirm: () => {
            const telefono = document.getElementById('telefono_contacto').value;
            if (!telefono) {
                Swal.showValidationMessage('El teléfono de contacto es requerido');
                return false;
            }
            return {
                telefono: telefono,
                comentarios: document.getElementById('comentarios').value || null
            };
        }
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            crearReservas(datosPorPaquete, result.value.telefono, result.value.comentarios);
        }
    });
}

async function crearReservas(datosPorPaquete, telefonoContacto, comentarios) {
    try {
        for (const datos of datosPorPaquete) {
            const response = await fetch('/api/reservas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    paquete_id: datos.paquete_id,
                    estado: 'confirmada',
                    numero_pasajeros: datos.numero_pasajeros,
                    telefono_contacto: telefonoContacto,
                    comentarios: comentarios,
                    viajeros: datos.viajeros
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Error al crear reserva');
            }
        }
        
        // Limpiar carrito después de crear todas las reservas
        await fetch('/api/carrito/limpiar', { method: 'POST' });
        
        Swal.fire({
            title: '¡Reservas Confirmadas!',
            text: 'Tus reservas se han creado exitosamente',
            icon: 'success',
            confirmButtonText: 'Ver Mis Reservas'
        }).then(() => {
            window.location.href = '/mis-reservas';
        });
    } catch (error) {
        Swal.fire('Error', error.message || 'Error al crear las reservas', 'error');
    }
}


// Usar la función global del contador
function actualizarContadorCarrito() {
    if (typeof actualizarContadorCarritoGlobal === 'function') {
        actualizarContadorCarritoGlobal();
    }
}

// Cargar carrito al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarCarrito();
});
</script>
{% endblock %}
